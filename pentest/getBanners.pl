#!/usr/bin/env perl
use strict; 
use warnings;
use Data::Dumper;
use Getopt::Std;


my %opts;
getopts('l:t:p:', \%opts);

my $lista_ip = $opts{'l'} if $opts{'l'}; #todos los hosts vivos
my $archivo_escaneo_tcp = $opts{'t'} if $opts{'t'};
my $proxychains = '';
$proxychains = $opts{'p'} if $opts{'p'};
system("rm .escaneo_puertos_banners/*");

open (MYINPUT,"<$lista_ip") || die "ERROR: Can not open the file $lista_ip\n";
while (my $ip=<MYINPUT>)
{ 
$ip =~ s/\n//g;
$ip =~ s/ //g;


#Obtener lista de puertos abierto de la IP
#my $puertos_abiertos=`grep "$ip (" $archivo_escaneo_tcp | grep -o "[0-9][0-9]*/open" | tr '\\n' ',	' | tr -d '/open'`;
my $puertos_abiertos=`grep $ip $archivo_escaneo_tcp | cut -d ":" -f2 | tr "\n" ","`;

### Eliminar puertos repetidos
my @valores = split(',', $puertos_abiertos);
my %visto;
my @valores_unicos =   grep { !$visto{$_}++   } @valores; #puertos unicos
my $puertos_abiertos_unicos = join "," => @valores_unicos;
###############

#chop($ports_open); # delete last char ','
if ($puertos_abiertos_unicos ne '')
{	
	$puertos_abiertos_unicos = $puertos_abiertos_unicos.',65000' ;
	print "Escaneado los puertos: $puertos_abiertos_unicos en la IP: $ip \n";
	SCAN:	
	my $nmap_instances=`ps aux | grep nmap | wc -l` - 1;
	if ($nmap_instances < 11)
		{ 
		 system("$proxychains nmap -sC -sV -n -Pn --open -O -p $puertos_abiertos_unicos $ip -oG .escaneo_puertos_banners/$ip.grep >> .escaneo_puertos_banners/$ip.txt 2>/dev/null &");	
		 }
	else
		{sleep 10; goto SCAN;}
	
	
}
#
}
