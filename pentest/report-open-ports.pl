#!/usr/bin/env perl
use strict; 
use warnings;
use Data::Dumper;
use Getopt::Std;


my %opts;
getopts('l:t:u:', \%opts);

my $ip_list = $opts{'l'} if $opts{'l'}; #all live hosts
my $scan_file_tcp = $opts{'t'} if $opts{'t'}; #all live hosts
my $scan_file_udp = $opts{'u'} if $opts{'u'}; #all live hosts


open (MYINPUT,"<$ip_list") || die "ERROR: Can not open the file $ip_list\n";
while (my $ip=<MYINPUT>)
{ 
    $ip =~ s/\n//g; 	
    #print "ip $ip";

    my $tcp_ports_open =  `grep "$ip:" $scan_file_tcp | cut -d ":" -f2 | tr "\n" ","`;
    chop($tcp_ports_open); # delete last char ','
    #print "ports_open $ports_open";
    
    my $udp_ports_open =`grep "$ip:" $scan_file_udp | cut -d ":" -f2 | tr "\n" ","|  sed "s/ //g" `;                                
    chop($udp_ports_open); # delete last char ','
    #print "ports_open $ports_open";
    
    #$ports_open
    if ($tcp_ports_open ne '' || $udp_ports_open ne '')
    {
        print "ip $ip tcp_ports_open ($tcp_ports_open) udp_ports_open ($udp_ports_open)\n";
        open (SALIDA,">>../reportes/NMAP-resumen.txt") || die "ERROR: No puedo abrir el fichero ../reportes/NMAP-resumen.txt\n";
        print SALIDA "$ip"."\tTCP: ".$tcp_ports_open."\tUDP: ".$udp_ports_open."\n";
        close (SALIDA);
    }
}
