#!/bin/bash
# nmap-grep.sh
# 12/28/2015 by by Ted R (http://github.com/actuated)
# Script for parsing and splitting grepable nmap output files
# 12/28/2015 - Changed summary output to printf table
# 12/30/2015 - Changed sort option for summary table to use sort -V
# 1/1/2016 - Aesthetic change

varTempRandom=$(( ( RANDOM % 9999 ) + 1 ))
varTempFile="temp-nmp-$varTempRandom.txt"
if [ -f "$varTempFile" ]; then rm $varTempFile; fi
# Check for input file as first parameter, error if it doesn't exist as a file
varInFile="$1"

# Process each comma-separated open port result to the CSV temp file, with the host IP
varLine=""
while read varLine; do
  varCheckForOpen=""
  varCheckForOpen=$(echo $varLine | grep '/open/')
  if [ "$varCheckForOpen" != "" ]; then
    varLineHost=$(echo $varLine | awk '{print $2}')
    varLinePorts=$(echo $varLine | awk '{$1=$2=$3=$4=""; print $0}')
# Create temporary file to write each port result for this host
      varTempRandom2=$(( ( RANDOM % 9999 ) + 1 ))
      varTempFile2="temp-nmp2-$varTempRandom2.txt"
      if [ -f "$varTempFile2" ]; then rm $varTempFile2; fi
      echo "$varLinePorts" | tr "," "\n" | sed 's/^ *//g' >> $varOutPath$varTempFile2
# Read the per-host temp file to write each open port as a line to the CSV temp file
    while read varTempLine; do
      varCheckForOpen=""
      varCheckForOpen=$(echo $varTempLine | grep "/open/")
      if [ "$varCheckForOpen" != "" ]; then
        varLinePort=$(echo $varTempLine | awk -F '/' '{print $1}')
        varLineTCPUDP=$(echo $varTempLine | awk -F '/' '{print $3}')
        varLineProto=$(echo $varTempLine | awk -F '/' '{print $5}')
        varLineSvc=$(echo $varTempLine | awk -F '/' '{print $7}')
        echo "$varLineHost,$varLinePort,$varLineTCPUDP,$varLineProto,$varLineSvc" >> $varOutPath$varTempFile
      fi
    done < $varOutPath$varTempFile2
    rm $varOutPath$varTempFile2
  fi
done < $varInFile

mv $varOutPath$varTempFile ${varOutPath}unsorted.txt
cat ${varOutPath}unsorted.txt | sort -V | uniq > $varOutPath$varTempFile
rm ${varOutPath}unsorted.txt

  
varLastHost=""
while read varLine; do
varLineHost=""
varLinePort=""
varLineTCPUDP=""
varLineProto=""
varLineSvc=""
varLineHost=$(echo $varLine | awk -F ',' '{print $1}')
varLinePort=$(echo $varLine | awk -F ',' '{print $2}')
printf "%-18s %-14s   \n" "$varLineHost:$varLinePort" 
varLastHost="$varLineHost"
done < $varOutPath$varTempFile  

rm $varOutPath$varTempFile

